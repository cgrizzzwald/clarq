<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>âš¡ CLARQ Risk Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>âš¡ CLARQ Risk Dashboard</h1>
    <p>AI-Powered Supply Chain Intel</p>
  </header>

  <div class="container">
    <!-- ğŸ“Œ Summary -->
    <div class="card summary">
      <h2>ğŸ“Œ Latest Risk Summary</h2>
      <p id="risk-summary">Loading summary...</p>
    </div>

    <!-- ğŸ“° Top Headlines -->
    <div class="card">
      <h2>ğŸ“° Top Headlines</h2>
      <ul id="headline-list"></ul>
    </div>

    <!-- ğŸ”¥ Risk Blocks -->
    <div id="risk-blocks"></div>

    <!-- ğŸ•µï¸ Rumor Watch -->
    <div id="rumor-watch"></div>

    <!-- ğŸ›  Admin Panel -->
    <div class="card" style="border: 2px dashed #ccc;">
      <h2>ğŸ›  Admin Panel</h2>
      <p>Click below to manually refresh CLARQ headline data.</p>
      <form action="/refresh-headlines" method="get" target="_blank">
        <input type="hidden" name="key" value="clarqbolt55" />
        <button type="submit" style="background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none;">
          ğŸ”„ Refresh Headlines
        </button>
      </form>
    </div>
  </div>

  <footer>&copy; 2025 CLARQ. Built with grit and AI.</footer>

  <!-- ğŸ“œ JS Logic -->
  <script>
    async function loadDashboard() {
      try {
        // Risk Summary + Blocks
        const riskRes = await fetch("/api/risks");
        const data = await riskRes.json();
        const summary = data.find(b => b.type === "summary");
        document.getElementById("risk-summary").innerText = summary?.content || 'No summary available';

        const blocks = data.filter(b => b.type === "risk");
        const riskContainer = document.getElementById("risk-blocks");

        blocks.forEach((block, idx) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h3>${block.category || 'Unnamed Category'} â€” Risk: ${block.rating || '?'}</h3>
            <p>${block.description || ''}</p>
            ${block.why_it_matters ? `<p><strong>ğŸ§  Why It Matters:</strong> ${block.why_it_matters}</p>` : ""}
            ${block.impact ? `<p><strong>ğŸ’¥ Impact:</strong> ${block.impact}</p>` : ""}
            ${block.suggested_action ? `<p><strong>ğŸ›  Action:</strong> ${block.suggested_action}</p>` : ""}
          `;
          riskContainer.appendChild(card);
        });

        // Rumor Watch
        const rumor = data.find(b => b.type === "rumor");
        if (rumor?.rumors?.length) {
          const wrapper = document.getElementById("rumor-watch");
          const box = document.createElement("div");
          box.className = "card";
          box.innerHTML = `<h3>ğŸ” Rumor Watch</h3>
            ${rumor.rumors.map(r => `
              <div style="margin-bottom: 1rem;">
                <p><strong>Rumor:</strong> ${r.content}</p>
                ${r.source ? `<p><strong>Source:</strong> ${r.source}</p>` : ""}
                ${r.severity ? `<p><strong>Severity:</strong> ${r.severity}</p>` : ""}
                ${r.suggested_action ? `<p><strong>Action:</strong> ${r.suggested_action}</p>` : ""}
              </div>`).join("")}`;
          wrapper.appendChild(box);
        }

        // Top Headlines
        const headlineRes = await fetch("/api/headlines");
        const headlines = await headlineRes.json();
        const list = document.getElementById("headline-list");
        if (headlines.length) {
          headlines.forEach(h => {
            const li = document.createElement("li");
            li.innerHTML = `<a href="${h.link}" target="_blank" style="color: #3b82f6;">${h.title}</a> <small>(${h.source})</small>`;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = "<li>No headlines found.</li>";
        }
      } catch (err) {
        console.error("Dashboard load failed:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", loadDashboard);
  </script>
</body>
</html>
