<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>âš¡ CLARQ Risk Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>âš¡ CLARQ's balls Risk Dashboard</h1>

    <div class="summary-card">
      <h3 class="summary-title">ðŸ“Œ Latest Risk Summary</h3>
      <p id="risk-summary">Loading risk summary...</p>
    </div>

    <div id="risk-blocks"></div>
    <div id="history-blocks"></div>
  </div>

  <script>
    function toggleExtra(idx) {
      const el = document.getElementById("extra-" + idx);
      el.classList.toggle("hidden");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch("/api/risks");
        const data = await res.json();

        // Summary
        const summary = data.find(b => b.type === "summary");
        document.getElementById("risk-summary").innerText = summary?.content || 'No summary found.';

        // Risk blocks
        const blocks = data.filter(b => b.type === "risk");
        const riskContainer = document.getElementById("risk-blocks");
        blocks.forEach((block, idx) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="card-content">
              <h2>
                <span class="category-title" style="color: #facc15">${block.category || 'Unnamed Category'}</span>
                ${block.rating ? `<span class="risk-rating-badge ${block.rating <= 3 ? 'risk-low' : block.rating <= 6 ? 'risk-medium' : 'risk-high'}">Risk Rating: ${block.rating}</span>` : ""}
              </h2>
              <p>${block.description || ''}</p>
              ${block.trend ? `
                <div class="trend-container">
                  <canvas class="trendChart" data-trend='${JSON.stringify(block.trend)}' width="200" height="60"></canvas>
                  <div class="trend-label" style="text-align:center;">Trend: Last 30 Days</div>
                </div>
              ` : ""}
              ${block.why_it_matters ? `<p class="insight-label">ðŸ§  Why It Matters:</p><p>${block.why_it_matters}</p>` : ""}
              ${block.impact ? `<p class="insight-label">ðŸ’¥ Impact on Your Ops:</p><p>${block.impact}</p>` : ""}
              ${block.suggested_action ? `<p class="insight-label">ðŸ›  Suggested Action:</p><p>${block.suggested_action}</p>` : ""}
              ${block.headlines?.length ? `
                <p class="insight-label">ðŸ“° Top Headlines:</p>
                <ul class="sources">
                  ${block.headlines.slice(0, 3).map(src => `<li>${src.title} â€” Severity ${src.severity}</li>`).join("")}
                </ul>
                ${block.headlines.length > 3 ? `
                  <ul class="sources hidden" id="extra-${idx}">
                    ${block.headlines.slice(3).map(src => `<li>${src.title} â€” Severity ${src.severity}</li>`).join("")}
                  </ul>
                  <span class="show-more-link" onclick="toggleExtra(${idx})">Show More Headlines</span>
                ` : ""}
              ` : ""}
            </div>
            <div class="ops-tip">
              ðŸ’¡ <strong>Ops Tip:</strong><br/>
              Watch for secondary effects tied to this risk. Could it delay shipments? Impact pricing? Loop in your team and prep alternatives if needed.
            </div>
          `;
          riskContainer.appendChild(card);
        });

        // Historical insight blocks
        const historyBlocks = data.filter(b => b.type === "history");
        const historyContainer = document.getElementById("history-blocks");
        historyBlocks.forEach(block => {
          const div = document.createElement("div");
          div.className = "history-block";
          div.innerHTML = `<h3>ðŸ“š Historical Insight</h3><p>${block.content}</p>`;
          historyContainer.appendChild(div);
        });

        // Chart rendering
        document.querySelectorAll(".trendChart").forEach(canvas => {
          const data = JSON.parse(canvas.dataset.trend || "[]");
          const ctx = canvas.getContext("2d");

          const gradient = ctx.createLinearGradient(0, 0, 0, 60);
          gradient.addColorStop(0, "#ef4444");  // Red
          gradient.addColorStop(0.5, "#f59e0b"); // Yellow
          gradient.addColorStop(1, "#10b981");  // Green

          new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(() => ""),
              datasets: [{
                data,
                borderColor: gradient,
                backgroundColor: "rgba(255, 255, 255, 0.05)",
                tension: 0.3,
                fill: true,
                pointRadius: 0,
                borderWidth: 2
              }]
            },
            options: {
              responsive: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: {
                  min: 0,
                  max: 10,
                  ticks: {
                    stepSize: 1,
                    callback: v => v === 0 ? "0 (Low)" : v === 10 ? "10 (High)" : ""
                  },
                  grid: {
                    drawBorder: false,
                    color: ctx => {
                      const y = ctx.tick.value;
                      return y < 4 ? "#10b981" : y < 7 ? "#f59e0b" : "#ef4444";
                    }
                  }
                }
              }
            }
          });
        });

      } catch (e) {
        console.error("Failed to load risk data", e);
        document.getElementById("risk-blocks").innerHTML = "<p>Error loading data.</p>";
      }
    });
  </script>
</body>
</html>
